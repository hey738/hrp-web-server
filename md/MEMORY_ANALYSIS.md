# 캐시 메모리 사용량 분석

## 실제 데이터 크기 측정

### 경계 데이터 크기 (JSON 형식)

#### 서울특별시 (sido)
```json
{
  "type": "MultiPolygon",
  "coordinates": [...],  // 약 5,000개 좌표
  "centroid": {"lng": 126.978, "lat": 37.566}
}
```
- **예상 크기**: ~500KB (좌표 개수에 따라)

#### 종로구 (sigungu)
- **예상 크기**: ~200KB

#### 청운효자동 (dong)
- **예상 크기**: ~50KB

### 전체 행정구역 개수

```python
전국 통계 (2024년 기준):
- 시/도: 17개
- 시/군/구: 252개
- 행정동: 3,558개
==================
총 3,827개 행정구역
```

### 최악의 시나리오 (모든 행정구역 캐싱)

```
17개 시/도 × 500KB = 8.5MB
252개 시/군/구 × 200KB = 50.4MB
3,558개 행정동 × 50KB = 177.9MB
=====================================
총 약 237MB
```

**실제로는**: 사용자가 모든 지역을 조회하지 않으므로 훨씬 적음

### 현실적인 사용량 (80/20 법칙 적용)

```
주요 조회 지역 (상위 20%):
- 서울, 경기, 부산, 인천, 대구 (5개 시/도)
- 주요 시/군/구 (약 50개)
- 주요 행정동 (약 200개)

예상 메모리 사용:
5 × 500KB = 2.5MB (시/도)
50 × 200KB = 10MB (시/군/구)
200 × 50KB = 10MB (행정동)
=====================================
총 약 22.5MB
```

## 클라우드 서버 메모리 비용

### AWS EC2 가격 예시 (서울 리전, 2024)

| 인스턴스 타입 | RAM | vCPU | 시간당 | 월간 (730시간) |
|--------------|-----|------|--------|----------------|
| t3.micro | 1GB | 2 | $0.0116 | ~$8.47 |
| t3.small | 2GB | 2 | $0.0232 | ~$16.94 |
| t3.medium | 4GB | 2 | $0.0464 | ~$33.87 |

### 메모리 추가 비용 계산

```
1GB 메모리 추가 비용: 약 $8/월

캐시 사용 메모리:
- 현실적: 22.5MB → 약 $0.18/월
- 최악: 237MB → 약 $1.90/월
```

### Supabase 비용 절감 vs 메모리 비용

```
Supabase 절감액: $50-75/월
메모리 추가 비용: $0.18-1.90/월
=====================================
순 절감액: $48-75/월 💰

ROI: 2,500-4,100% (25-41배 이득!)
```

## 문제점과 해결책

### 문제 1: 무한정 증가

현재 구현은 **제한 없음** → 메모리 누수 가능

### 해결책: LRU Cache + 크기 제한

```python
MAX_CACHE_SIZE = 100  # 최대 100개 항목
MAX_CACHE_MEMORY = 100 * 1024 * 1024  # 100MB

자동으로 오래된 항목 삭제 (LRU: Least Recently Used)
```

## 권장 설정

### 소규모 서비스 (< 1,000 사용자/일)
```python
MAX_CACHE_SIZE = 50개
예상 메모리: ~10MB
추가 비용: ~$0.08/월
```

### 중규모 서비스 (1,000-10,000 사용자/일)
```python
MAX_CACHE_SIZE = 100개
예상 메모리: ~20MB
추가 비용: ~$0.16/월
```

### 대규모 서비스 (10,000+ 사용자/일)
```python
MAX_CACHE_SIZE = 500개
예상 메모리: ~100MB
추가 비용: ~$0.80/월

또는 Redis 사용 권장 (별도 비용)
```

## 메모리 모니터링

### Python 메모리 사용량 확인

```python
import sys

# 캐시 크기 확인
cache_size = sys.getsizeof(boundary_cache)
print(f"캐시 메모리 사용량: {cache_size / 1024 / 1024:.2f}MB")
```

### 경고 임계값 설정

```python
if len(boundary_cache) > MAX_CACHE_SIZE * 0.9:
    logger.warning(f"캐시 용량 90% 도달: {len(boundary_cache)}/{MAX_CACHE_SIZE}")
```

## 결론

### 메모리 비용은 거의 무시할 수준

```
월 비용 비교:

Supabase 절감: $50-75/월
메모리 추가: $0.16-0.80/월 (제한된 캐시)
=====================================
순 이득: $49-75/월

결론: 압도적으로 이득! ✅
```

### 단, 제한은 필요

- ✅ 최대 항목 수 제한 (100-500개)
- ✅ 최대 메모리 크기 제한 (50-200MB)
- ✅ LRU 자동 삭제
- ✅ 메모리 모니터링

### 다음 단계: 제한된 캐시 구현

현재 구현에 추가할 것:
1. `MAX_CACHE_SIZE` 설정
2. LRU (Least Recently Used) 삭제 로직
3. 메모리 사용량 추적
4. 경고 로깅
